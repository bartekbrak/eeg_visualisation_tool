<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>{{ title if title else "Bokeh Plot" }}</title>
    {{ plot_resources|indent(8) }}
    {{ plot_script|indent(8) }}
<script>
// python like string interpolation
// alert("I'm {age} years old!".format({ age: 29 }));
String.prototype.format = function (o) {
    return this.replace(/{([^{}]*)}/g,
        function (a, b) {
            var r = o[b];
            return typeof r === 'string' || typeof r === 'number' ? r : a;
        }
    );
};
var evt = {}; // namespace
document.addEventListener("DOMContentLoaded", function() {
    evt = {
        video: document.querySelector('video'),
        ready_to_play: true,
        hover_position: 0,
        progress: 0,
        line_y: {{ progress_bar_y }},
        progress_bar: Bokeh.Collections('ColumnDataSource').get('{{ progress_bar_id }}'),
        update_resolution: 10,
        bk_canvas_events: document.getElementsByClassName('bk-canvas-events'),
        update_progress_bar: function () {
            evt.progress = parseInt(evt.video.currentTime * 1000);
            evt.progress_bar.set('data', {
                x: [evt.progress, evt.progress],
                y: evt.line_y
            });
            Bokeh.$("#timer").html(evt.fromSeconds(evt.video.currentTime));
            setTimeout(evt.update_progress_bar, evt.update_resolution);
        },
        line_toggle: function (input) {
            var j = Bokeh.$(input);
            var id = j.data('id');
            var line = this.lines[id];
            if (input.checked)
                line.cds.set('data', line.orig_data);
            else
                line.cds.set('data', {});
        },
        toggle_video: function () {
            if (evt.ready_to_play) {
                evt.video.play();
                evt.ready_to_play = false;
            } else {
                evt.video.pause();
                evt.ready_to_play = true;
            }
        },
        rewind_to_hover: function () {
            evt.video.pause();
            evt.video.currentTime = evt.hover_position;
            evt.ready_to_play = true;
        },
        window_keydown: function (event) {
            if (event.keyCode == 32) {
                evt.toggle_video();
                event.preventDefault();
            }
        },
        video_ended: function () {
            evt.ready_to_play = true;
        },
        lines: {},
        fromSeconds: function (seconds) {
            var m = ('0' + Math.floor(seconds / 60)).slice(-2);
            var s = ('0' + parseInt(seconds % 60, 10)).slice(-2);
            var ms = ('' + (seconds % 1).toFixed(3)).slice(2, 5);
            if (isNaN(ms)) ms = '000';
            return '{m}:{s}:{ms}'.format({m: m, s: s, ms: ms});
        }
    };
    Bokeh.$('input.toggler').change(function() {
        evt.line_toggle(this);
    });
    Bokeh.$('input.grouper').change(function() {
        var group_name = Bokeh.$(this).data("group-name");
        var plot_no = Bokeh.$(this).data("plot-no");
        var togglers = Bokeh.$('input.toggler[data-group-name="' + group_name + '"][data-plot-no="' + plot_no + '"]');
        togglers.prop('checked', this.checked);
        togglers.trigger("change");
    });    
    {# prevent leaving focus on the checkbox, we use space to toggle video 
       which, with focus here, would also toggle the checkbox #}
    Bokeh.$('input[type=checkbox]').mousedown(function (event) {
        event.preventDefault();
    });    
 
    for (var i = 0; i < evt.bk_canvas_events.length; i++) {
        evt.bk_canvas_events[i].addEventListener("dblclick", evt.rewind_to_hover); 
    }
    {% for line_groups in line_groups_per_plot %}
        var legend = '#legend{i}'.format({i: {{ loop.index }}});
        var plot_wrapper = '.bk-plot-wrapper:eq({i})'.format({i: {{ loop.index0 }}});

        Bokeh.$(legend).appendTo(plot_wrapper);
{#        Bokeh.$('input.grouper[data-plot-no="{{ loop.index0 }}"]:eq({{ loop.index0 }})').prop('checked', true);#}
        {% for lines in line_groups.values() %}{% for line in lines -%}
            evt.lines['{{ line.source._id }}'] = {
                cds: Bokeh.Collections("ColumnDataSource").get('{{ line.source._id }}'),
                orig_data: Bokeh.Collections("ColumnDataSource").get('{{ line.source._id }}').get('data'),
                orig_color: '{{ line.color }}'
            };
    {% endfor -%}{% endfor %}{% endfor %}

    window.addEventListener("keydown", evt.window_keydown);
    evt.video.addEventListener('ended', evt.video_ended);
    evt.video.addEventListener('mousedown', evt.toggle_video);
    evt.update_progress_bar();
    Bokeh.$('input').trigger("change");

    
});
</script>
<style>
    body {
        margin-left: 200px;
        background: white url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAYAAACtWK6eAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wgFFg0bD3LXygAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAATNSURBVHja7drdTuM6FIDRHTsuFMH7vyjiJ3Hic5WoQDPNHB1pmjNrSVxQakZi8mXbbbvWWgvgquRPAAIBgYBAQCAgEBAICAQEAgIBBAICAYGAQEAgIBAQCAgEBAICAQQCAgGBgEBAICAQEAgIBAQCCAQEAgIBgYBAQCAgEBAICAQEAggEflP/J//x19fXq4/nnCPnHH3fR0pp17qu66KUEqWU6Lpu8/mn0ylOp9OXn9da4+PjY/3++fnZlcH9TpBpmmIYhnh7e4tpmnataa3FMAwxDMMvn1dr/fHYOI6uBO5vgny/Y7fWYp7nmOc5hmGI1lq8v7/H09PT1UmyrJvnOcZxXL8eHh42J1OtNaZpipzzurbWGn3f744RE+SP6Loucs5RSonz+bxulW7d4VNKUUq5+fuX7dflFKm1rtszOMwhPaW0nhVu3dmXCbJMiS3Lz2qt0Vr7Et+v1mGLdZcut0G3DvmttSil/DiAXzvIj+O4Rres+36wh7ueIMsFvVzEe547TdPVQ/iXO0Lfr5Njee7yGBxqgixhbN3dvx/uPz8/11extiZJzjlSSusESSnZXnHMCXJ5Ee853D8+Pu461F9ODNODQwayvNT7bw7QW2eWyyhaa9FaEwjH2WItF+3yRuGyxbr1EuzlFmvPxEkpxcvLi/99jhHI1kdOIiLO5/PmBX9tXWtt3WrB/26CdF0XKaXo+37zs1hb65Y3GW2b+K90bc9rqOCQDggEBAICAYGAQEAgIBAQCAgEEAgIBAQCAgGBgEBAICAQEAgIBBAICAQEAgIBgYBAQCAgEBAICAQQCAgEBAICAYGAQEAgIBAQCCAQEAgIBAQCAgGBgEBAICAQEAggEBAICAQEAgIBgYBAQCAgEEAgIBAQCAgEBAICAYGAQEAgIBBAICAQEAgIBAQCAgGBgEBAIIBAQCAgEBAICATuSO9P8Hd5fX29+njOOXLO0fd9pJR2reu6LkopUUqJrus2n386neJ0On35ea01Pj4+1u+fn59NEO7XNE0xDEO8vb3FNE271rTWYhiGGIbhl8+rtf54bBxHE4T7tdyxW2sxz3PM8xzDMERrLd7f3+Pp6enqJFnWzfMc4ziuXw8PD5uTqdYa0zRFznldW2uNvu93x2iC8Ed0XRc55yilxPl8XrdKt+7wKaUopdz8/cv263KK1FrX7ZlDOoeRUlrPCrfu7MsEWabEluVntdZorX2J71frbLG4S5fboFuH/NZalFJ+HMCvHeTHcVyjW9Z9P9ibIBxiy7VcxHueO03T1UP4l7tw36+TY3nu8pgJwqEsYWzd3b8f7j8/P9dXsbYmSc45UkrrBEkpHWJ7ZYLww+VFvOdw//j4uOtQfzkxjjI9BMKPg/cyDX73Dr91ZrmMorUWrbVDBWKLZUsVrbX1jcJli3XrJdjLLdaeiZNSipeXl8P9fQTyl9r6yElExPl83rzgr61rra1brf8bgZgg0XVdpJSi7/vNz2JtrVveZDzStul3dG3P63nwl3JIB4GAQEAgIBAQCAgEBAICAYEAAgGBgEBAICAQEAgIBAQCAgGBAAIBgYBAQCAgEBAICAQEAgIBBAICAYGAQEAgIBAQCAgEBAICAQQCAgGBgEBAICAQEAgIBAQCCARu+gd8fc/1sK1+iAAAAABJRU5ErkJggg==) repeat;
        font-family: sans-serif;
    }
    .bk-logo {
        display:none !important;
    }
    /* this is bad, but I can't find what makes plots off-set by 1 pixel */
    video {
        margin-left: 1px;
        padding: 10px;
    }
    #aftervideo {
        width: 640px;
        height: 10px;
    }
    video, #aftervideo {
        background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAAKCAYAAABi8KSDAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wgFFSMksFVNggAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAADnSURBVBjTjc4xqsJAFIXh/84kBtKYdEHQtWQBWU125xasbCxTBgSLgCCOMsmxMfN4vOad5sLlK34zM/HPZU3TEGPk+XwSQmCeZwDMjCzLKMuSoihwzpH1fc/7/eZ8PnM8Hrnf75gZzjl2ux1d17Hf7/Heg747nU5qmkbfLOV5rq7rNE3TSuTWns1mQ1EUmFnKqOuaGGNqTlhSQutdf3+w9x5Jv4AknHM/OMZICIHL5cLj8Uh4WRaGYeB6vRJjZJ5nrG1bvV4vbrcb4zgSQkgZ2+2Ww+FAVVV47zFAqfXbu36FMAwhkPgA0K58ivEV69oAAAAASUVORK5CYII=)
            repeat-x;
    }
    .bk-plot-wrapper table:first-child {
        border: 1px solid lightgray;
    }
    .bk-plot-wrapper {
        margin-bottom: 5px;
    }
    .color_square {
        display: inline-block;
        padding: 2px 10px 2px 10px;
{#        margin: 5px;#}
{#        border-radius: 2px;#}
{#        border: 1px solid white;#}
        color: white;
        
        font-weight: 900;
{#        min-width: 20px;#}

    }
    label, input[type=checkbox] {
        cursor: pointer;
    }
    .legend {
        // border: 1px solid white;
        padding: 10px;
        color: gray;
        margin-top: 5px;
        vertical-align: middle;
    }
    .legend td {
        padding-left: 10px;
        vertical-align: top;
    }

    table {
        border-collapse: collapse;
    }
    .bk-plot-wrapper > table {
        display: inline-block;
        vertical-align: top;
    }
    .bk-plot-left {
        display: none;
    }
    .toggler {
        margin-left: 15px !important;
    }
    #timer {
        color: white;
        margin-left: 10px;
        font-family: monospace;
        font-size: 40px;
        vertical-align: top;
    }
    #logo {
        position: absolute;
        right: 10px;
        top: 10px;
        border: 1px solid lightgray;
        width: 200px;
        height: 100px;
        padding: 10px;
        color: lightgray;
    }
    #client {
        position: absolute;
        right: 10px;
        top: 140px;
        border: 1px solid lightgray;
        width: 200px;
        height: 100px;
        color: gray;
        padding: 10px;
    }
    #valency {
        width: 40px;
        border-bottom: 2px dashed orange;
        height: 1px;
        display: inline-block;
        vertical-align: middle;
        margin-right: 10px;
    }
</style>

</head>
<body>
    <video width=640 controls>
        <source type="video/mp4" src="data:video/mp4;base64,{{video_data}}">
    </video>
    <div id="aftervideo"></div><span id="timer">timer</span>
    {{ plot_div|indent(8) }}
<div id="legend_group">
{% for line_groups in line_groups_per_plot %}
    <table class="legend" id="legend{{ loop.index }}"><tr>
    {% set outer_loop = loop %}
    {% for group_name, lines in line_groups.iteritems() %}
        <td><label>
        <input type="checkbox" class="grouper" data-group-name="{{ group_name }}" data-plot-no="{{ outer_loop.index0 }}">
            {{ group_name }}
        </label>
        <br/>
        {% for line in lines %}
            <label>
            <input type="checkbox" class="toggler" data-id="{{ line.source._id }}" data-group-name="{{ group_name }}" data-plot-no="{{ outer_loop.index0 }}">
            {% for filter, value in line.description.items() %} 
                <div class="color_square" style="background-color: {{ line.color }}">{{ value }}</div> 
            {% endfor %}
            </label><br/>
        {% endfor %}
        </td>
    {% endfor %}
    </tr></table>
{% endfor %}
</div>
<div id="logo">logo</div>
<div id="client">
    klient: {{ client_name }}<br/>
    nazwa badania: {{ research_name }}<br>
    data: {{ date }}<br>
    próba: {{ sample_size }}
    <br>
    <div id="valency"></div>średnia walencyjna
</div>

</body>
</html>
